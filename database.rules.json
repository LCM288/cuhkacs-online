{
  "rules": {
    ".read": false,
    ".write": false,
    "members": {
      ".read": "auth.token.email.endsWith('@link.cuhk.edu.hk') && root.child('executives').child(auth.token.email.replace('@link.cuhk.edu.hk', '')).exists()",
      ".write": "auth.token.email.endsWith('@link.cuhk.edu.hk') && root.child('executives').child(auth.token.email.replace('@link.cuhk.edu.hk', '')).exists()",
      ".indexOn": "memberStatus/since",
      "$sid": {
        ".read": "auth.token.email.endsWith('@link.cuhk.edu.hk') && auth.token.email.replace('@link.cuhk.edu.hk', '') === $sid",
        ".write": "auth.token.email.endsWith('@link.cuhk.edu.hk') && auth.token.email.replace('@link.cuhk.edu.hk', '') === $sid && (!data.child('memberStatus').child('since').exists() || data.child('memberStatus').child('until').val() < now)",
        ".validate": "newData.hasChildren(['sid', 'name', 'studentStatus', 'createdAt', 'updatedAt']) && (newData.hasChildren(['memberStatus']) || !data.hasChildren(['memberStatus']))",
        "sid": {
          ".validate": "newData.isString() && newData.val().matches(/^\\d*$/) && newData.val().length < 16 && newData.val() === $sid"
        },
        "name": {
          ".validate": "newData.hasChildren(['eng'])",
          "chi": {
            ".validate": "!newData.exists() || (newData.isString() && newData.val().length < 64)"
          },
          "eng": {
            ".validate": "newData.isString() && newData.val().length < 128"
          },
          "$other": {
            ".validate": false
          }
        },
        "gender": {
          ".validate": "!newData.exists() || (newData.isString() && newData.val().matches(/^((fe)?male|other)$/))"
        },
        "dob": {
          ".validate": "!newData.exists() || newData.isString() && newData.val().matches(/^\\d{4}-\\d{2}-\\d{2}$/)"
        },
        "email": {
          ".validate": "!newData.exists() || (newData.isString() && newData.val().matches(/^.+@.+$/) && newData.val().length < 324)"
        },
        "phone": {
          ".validate": "!newData.exists() || (newData.isString() && newData.val().matches(/^\\+?\\d+(-\\d+)*$/) && newData.val().length < 64)"
        },
        "studentStatus": {
          ".validate": "newData.hasChildren(['college', 'major', 'entryDate', 'gradDate'])",
          "college": {
            ".validate": "newData.isString() && newData.val().matches(/^(CC|NA|UC|SC|WYS|WS|SH|MC|CW|NO)$/)"
          },
          "major": {
            ".validate": "newData.isString() && newData.val().matches(/^(\\w| )+$/) && newData.val().length < 256"
          },
          "entryDate": {
            ".validate": "newData.isString() && newData.val().matches(/^\\d{4}-\\d{2}-\\d{2}$/)"
          },
          "gradDate": {
            ".validate": "newData.isString() && newData.val().matches(/^\\d{4}-\\d{2}-\\d{2}$/)"
          },
          "$other": {
            ".validate": false
          }
        },
        "memberStatus": {
          ".validate": "newData.hasChildren(['since', 'lastRenewed', 'until']) && auth !== null && auth.token !== null && auth.token.email.endsWith('@link.cuhk.edu.hk') && root.child('executives').child(auth.token.email.replace('@link.cuhk.edu.hk', '')).exists()",
          "since": {
            ".validate": "(!data.exists() && newData.isNumber() && ((newData.val() > now - 1000 && newData.val() < now + 1000) || !data.parent().parent().exists())) || data.val() === newData.val()"
          },
          "lastRenewed": {
            ".validate": "((!data.exists() || newData.parent().child('until').val() > data.parent().child('until').val()) && newData.isNumber() && newData.val() > now - 1000 && newData.val() < now + 1000) || (newData.parent().child('until').val() <= data.parent().child('until').val() && data.val() === newData.val())"
          },
          "until": {
            ".validate": "newData.isNumber() || data.val() === newData.val()"
          },
          "$other": {
            ".validate": false
          }
        },
        "createdAt": {
          ".validate": "(!data.exists() && newData.isNumber() && newData.val() > now - 1000 && newData.val() < now + 1000) || data.val() === newData.val()"
        },
        "updatedAt": {
          ".validate": "newData.isNumber() && newData.val() > now - 1000 && newData.val() < now + 1000"
        },
        "$other": {
          ".validate": false
        }
      }
    },
    "executives": {
      ".read": "auth !== null && auth.token !== null && auth.token.email.endsWith('@link.cuhk.edu.hk') && root.child('executives').child(auth.token.email.replace('@link.cuhk.edu.hk', '')).exists()",
      ".write": "auth !== null && auth.token !== null && auth.token.email.endsWith('@link.cuhk.edu.hk') && root.child('executives').child(auth.token.email.replace('@link.cuhk.edu.hk', '')).exists()",
      "$sid": {
        ".read": "auth !== null && auth.token !== null && auth.token.email.endsWith('@link.cuhk.edu.hk') && auth.token.email.replace('@link.cuhk.edu.hk', '') === $sid",
        ".validate": "newData.hasChildren(['sid', 'displayName', 'title', 'createdAt', 'updatedAt'])",
        "sid": {
          ".validate": "newData.isString() && newData.val().matches(/^\\d*$/) && newData.val().length < 16 && newData.val() === $sid"
        },
        "displayName": {
          ".validate": "newData.isString() && newData.val().length < 128"
        },
        "title": {
          ".validate": "newData.isString() && newData.val().length < 128"
        },
        "createdAt": {
          ".validate": "(!data.exists() && newData.isNumber() && newData.val() > now - 1000 && newData.val() < now + 1000) || data.val() === newData.val()"
        },
        "updatedAt": {
          ".validate": "newData.isNumber() && newData.val() > now - 1000 && newData.val() < now + 1000"
        },
        "$other": {
          ".validate": false
        }
      }
    },
    "publicMessages": {
      ".read": "auth !== null && auth.token !== null && auth.token.email.endsWith('@link.cuhk.edu.hk') && root.child('executives').child(auth.token.email.replace('@link.cuhk.edu.hk', '')).exists()",
      ".write": "auth !== null && auth.token !== null && auth.token.email.endsWith('@link.cuhk.edu.hk') && root.child('executives').child(auth.token.email.replace('@link.cuhk.edu.hk', '')).exists()",
      ".validate": "newData.hasChildren(['welcome', 'member', 'registered', 'expired', 'visitor'])",
      "welcome": {
        ".read": true,
        ".validate": "newData.hasChildren(['message', 'updatedAt'])",
        "message": {
          ".validate": "newData.isString() && newData.val().length < 65536"
        },
        "updatedAt": {
          ".validate": "newData.isNumber() && newData.val() > now - 1000 && newData.val() < now + 1000"
        }
      },
      "member": {
        ".read": "auth !== null && auth.token !== null && auth.token.email.endsWith('@link.cuhk.edu.hk') && root.child('members').child(auth.token.email.replace('@link.cuhk.edu.hk', '')).exists()",
        ".validate": "newData.hasChildren(['message', 'updatedAt'])",
        "message": {
          ".validate": "newData.isString() && newData.val().length < 65536"
        },
        "updatedAt": {
          ".validate": "newData.isNumber() && newData.val() > now - 1000 && newData.val() < now + 1000"
        }
      },
      "expired": {
        ".read": "auth !== null && auth.token !== null && auth.token.email.endsWith('@link.cuhk.edu.hk') && root.child('members').child(auth.token.email.replace('@link.cuhk.edu.hk', '')).exists()",
        ".validate": "newData.hasChildren(['message', 'updatedAt'])",
        "message": {
          ".validate": "newData.isString() && newData.val().length < 65536"
        },
        "updatedAt": {
          ".validate": "newData.isNumber() && newData.val() > now - 1000 && newData.val() < now + 1000"
        }
      },
      "registered": {
        ".read": "auth !== null && auth.token !== null && auth.token.email.endsWith('@link.cuhk.edu.hk') && root.child('members').child(auth.token.email.replace('@link.cuhk.edu.hk', '')).exists()",
        ".validate": "newData.hasChildren(['message', 'updatedAt'])",
        "message": {
          ".validate": "newData.isString() && newData.val().length < 65536"
        },
        "updatedAt": {
          ".validate": "newData.isNumber() && newData.val() > now - 1000 && newData.val() < now + 1000"
        }
      },
      "visitor": {
        ".read": true,
        ".validate": "newData.hasChildren(['message', 'updatedAt'])",
        "message": {
          ".validate": "newData.isString() && newData.val().length < 65536"
        },
        "updatedAt": {
          ".validate": "newData.isNumber() && newData.val() > now - 1000 && newData.val() < now + 1000"
        }
      },
      "$other": {
        ".validate": false
      }
    },
    "$other" : {
      ".validate": false
    }
  }
}
